def interactiveExportByPrefixKML():
    fig, ax = plt.subplots()
    plt.subplots_adjust(bottom=0.3)
    ax.set_title("Exportar aeròdroms que comencen per una lletra/prefijo")

    # Caja para el prefijo
    tb_prefix = TextBox(plt.axes([0.2, 0.15, 0.6, 0.08]), "Prefix del codi (ex: L, LE, EH)")

    # Selección de región
    radio_map = RadioButtons(plt.axes([0.05, 0.05, 0.2, 0.15]), ('Catalunya', 'Espanya', 'Europa'))

    # Botón exportar
    btn_export = Button(plt.axes([0.7, 0.07, 0.25, 0.1]), "Exportar KML")

    state = {'selected_map': 'Catalunya'}
    airspaces = {
        'Catalunya': G_cat,
        'Espanya': G_spain,
        'Europa': G_eur
    }

    radio_map.on_clicked(lambda label: state.update({'selected_map': label}))

    def on_export_click(event):
        prefix = tb_prefix.text.strip().upper()
        G = airspaces[state['selected_map']]

        if not prefix:
            print("❌ Prefix no vàlid.")
            return

        # Buscar nodos que empiezan con el prefijo
        matching_nodes = [node for node in G.nodes if node.name.startswith(prefix)]

        if not matching_nodes:
            print(f"❌ No s'han trobat nodes amb el prefix {prefix}")
            return

        # Crear archivo KML
        kml = simplekml.Kml()
        for node in matching_nodes:
            pnt = kml.newpoint(name=node.name, coords=[(node.x, node.y)])
            pnt.style.iconstyle.color = simplekml.Color.green
            pnt.style.iconstyle.icon.href = 'http://maps.google.com/mapfiles/kml/paddle/grn-circle.png'

        filename = f"Aeroports_comencen_{prefix}_{state['selected_map']}.kml"
        kml.save(filename)
        print(f"✅ Exportat a {filename} ({len(matching_nodes)} nodes)")

    btn_export.on_clicked(on_export_click)
    plt.show()
interactiveExportByPrefixKML()
